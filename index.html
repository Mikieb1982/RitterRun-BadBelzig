<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RitterRun Enhanced - Bad Belzig (Higher Jump)</title> <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* Basic Reset & Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Define Bad Belzig Color Palette as CSS Variables */
        :root {
            --bb-green: #0ca644;
            --bb-blue: #0296c6;
            --bb-yellow: #f5d306;
            --bb-black: #151513;
            --bb-white: #ffffff;
            --font-pixel: 'Press Start 2P', cursive; /* Pixel font */
            --font-sans: 'Arial', sans-serif; /* Fallback font */
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #222; /* Dark background */
            margin: 0;
            font-family: var(--font-sans); /* Default font */
        }

        #game-container {
            position: relative;
            /* Use max-width for better responsiveness */
            width: 100%;
            max-width: 800px; /* Original width */
            aspect-ratio: 2 / 1; /* Maintain 800x400 ratio */
            border: 3px solid #555;
            overflow: hidden; /* Hide anything outside the container */
            background-color: var(--bb-blue); /* Default background if canvas fails */
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            /* Background color set dynamically or via CSS if needed */
        }

        /* UI Screen Styling (Start/Game Over) */
        .ui-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8); /* Darker overlay */
            color: var(--bb-white);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 30;
            padding: 20px;
            font-family: var(--font-pixel); /* Use pixel font for UI */
            line-height: 1.6;
        }

        .ui-screen h1 {
            font-size: 2.5em; /* Adjusted for pixel font */
            margin-bottom: 20px;
            color: var(--bb-yellow);
            text-shadow: 3px 3px 0px var(--bb-black); /* Pixel shadow */
        }

        .ui-screen h2 {
            font-size: 2.2em; /* Adjusted for pixel font */
            margin-bottom: 20px;
            color: #DC143C; /* Keep red for Game Over */
            text-shadow: 3px 3px 0px var(--bb-black); /* Pixel shadow */
        }

        .ui-screen p {
            font-size: 1em; /* Adjusted for pixel font */
            margin: 10px 0;
        }

        /* General Button Styling (used for Start/Restart) */
        .ui-button {
            padding: 15px 30px;
            font-size: 1.1em; /* Adjusted for pixel font */
            font-family: var(--font-pixel); /* Ensure pixel font */
            margin-top: 30px;
            cursor: pointer;
            background-color: #eee;
            border: 3px solid var(--bb-black); /* Solid border */
            color: var(--bb-black);
            text-transform: uppercase;
            transition: background-color 0.15s ease, transform 0.1s ease;
            box-shadow: 4px 4px 0px var(--bb-black); /* Pixel shadow */
        }

        .ui-button:hover {
            background-color: #ddd;
        }

        .ui-button:active {
            background-color: #ccc;
            transform: translate(2px, 2px); /* Button press effect */
            box-shadow: 2px 2px 0px var(--bb-black);
        }

        .instructions {
            margin-top: 25px;
            font-size: 0.8em !important; /* Adjusted for pixel font */
            color: #ccc;
            line-height: 1.5;
        }

        /* In-Game Score Display */
        #scoreDisplay {
            position: absolute;
            top: 15px;
            left: 15px;
            font-size: 1.5em; /* Adjusted for pixel font */
            font-family: var(--font-pixel);
            color: var(--bb-white);
            text-shadow: 2px 2px 0px var(--bb-black); /* Pixel shadow */
            z-index: 20;
        }

        /* POI Overlay Styling */
        .poi-overlay {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            background-color: rgba(0, 0, 0, 0.85);
            border: 3px solid var(--bb-yellow);
            border-radius: 0;
            z-index: 50;
            color: var(--bb-white);
            padding: 15px 20px;
            text-align: center;
            font-family: var(--font-pixel);
            box-shadow: 4px 4px 0px rgba(0,0,0,0.5);
            display: none; /* Hidden by default */
        }

        .poi-overlay.visible {
            display: block !important; /* Show when visible class is added */
        }

        .poi-overlay h3 {
            margin-bottom: 10px;
            font-size: 1.1em;
            color: var(--bb-yellow);
            text-shadow: 2px 2px 0px var(--bb-black);
        }

        .poi-overlay p {
            font-size: 0.9em;
            line-height: 1.6; /* Increased line height */
            color: var(--bb-white);
            margin-bottom: 15px; /* Add space before button */
        }

        /* Styling for the new Close button */
        #closePoiButton {
             padding: 8px 15px;
             font-size: 0.9em; /* Slightly smaller */
             font-family: var(--font-pixel);
             cursor: pointer;
             background-color: #ccc;
             border: 2px solid var(--bb-black);
             color: var(--bb-black);
             margin-top: 10px; /* Space above button */
             box-shadow: 2px 2px 0px var(--bb-black);
        }
         #closePoiButton:hover {
             background-color: #bbb;
         }
         #closePoiButton:active {
             background-color: #aaa;
             transform: translate(1px, 1px);
             box-shadow: 1px 1px 0px var(--bb-black);
         }

        /* Utility class to hide elements reliably */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>

        <div id="poiInfoOverlay" class="poi-overlay">
            <h3 id="poiName">POI Name</h3>
            <p id="poiInfoText">POI information will appear here.</p>
            <button id="closePoiButton">Close</button> </div>

        <div id="startScreen" class="ui-screen">
            <h1>RitterRun</h1>
            <p>Explore Bad Belzig!</p>
            <p>High Score: <span id="startHighScore">0</span></p>
            <button id="startButton" class="ui-button">Start Game</button>
            <p class="instructions">Press SPACE or Click Start<br>Press SPACE to Jump</p>
        </div>

        <div id="gameOverScreen" class="ui-screen hidden">
            <h2>Game Over!</h2>
            <p>Score: <span id="finalScore">0</span></p>
            <p>High Score: <span id="gameOverHighScore">0</span></p>
             <button id="restartButton" class="ui-button">Restart</button>
        </div>

        <div id="scoreDisplay" class="hidden">Score: <span id="currentScore">0</span></div>
    </div>

    <script>
        // --- Strict mode and IIFE ---
        (function() {
            'use strict';

            // --- DOM Element References ---
            const canvas = document.getElementById('gameCanvas');
            const gameContainer = document.getElementById('game-container');
            const startScreen = document.getElementById('startScreen');
            const gameOverScreen = document.getElementById('gameOverScreen');
            const startButton = document.getElementById('startButton');
            const restartButton = document.getElementById('restartButton');
            const scoreDisplay = document.getElementById('scoreDisplay');
            const currentScoreSpan = document.getElementById('currentScore');
            const finalScoreSpan = document.getElementById('finalScore');
            const startHighScoreSpan = document.getElementById('startHighScore');
            const gameOverHighScoreSpan = document.getElementById('gameOverHighScore');
            const poiOverlay = document.getElementById('poiInfoOverlay');
            const poiNameEl = document.getElementById('poiName');
            const poiInfoTextEl = document.getElementById('poiInfoText');
            const closePoiButton = document.getElementById('closePoiButton');

            // --- Canvas and Context ---
            let ctx;
            let canvasWidth;
            let canvasHeight;

            // --- Essential Element Check ---
            if (!canvas || !canvas.getContext || !gameContainer) {
                console.error("Fatal Error: Canvas or Game Container not found or canvas context not supported!");
                alert("Fatal Error: Cannot initialize the game. Try a different browser or check the HTML structure.");
                return;
            }
            ctx = canvas.getContext('2d');

            const requiredElements = { startScreen, gameOverScreen, startButton, restartButton, scoreDisplay, currentScoreSpan, finalScoreSpan, startHighScoreSpan, gameOverHighScoreSpan, poiOverlay, poiNameEl, poiInfoTextEl, closePoiButton };
            for (const key in requiredElements) {
                if (!requiredElements[key]) {
                    console.error(`Fatal Error: UI element with ID '${key}' not found in index.html!`);
                    alert(`Fatal Error: UI element missing (${key})! Check index.html.`);
                    return;
                }
            }

            // --- Game States ---
            const GameState = Object.freeze({ MENU: 'MENU', PLAYING: 'PLAYING', GAME_OVER: 'GAME_OVER', LOADING: 'LOADING' });
            let currentGameState = GameState.LOADING;

            // --- Collision Types ---
            const CollisionType = Object.freeze({ NONE: 0, TOP: 1, SIDE: 2 });

            // --- Game Constants ---
            const GROUND_HEIGHT = 30;
            const PLAYER_INITIAL_X = 60;
            const PLAYER_WIDTH = 40;
            const PLAYER_HEIGHT = 40;
            const PLAYER_GRAVITY = 0.65;
            // --- MODIFIED: Increased Jump Power ---
            const PLAYER_JUMP_POWER = -16; // Was -14. More negative = higher jump.
            const PLAYER_BOUNCE_POWER_MULTIPLIER = 0.8;
            const OBSTACLE_STONE_WIDTH = 35;
            const OBSTACLE_STONE_HEIGHT = 35;
            const OBSTACLE_TRACTOR_WIDTH = 70;
            const OBSTACLE_TRACTOR_HEIGHT = 45;
            const POI_SIGN_WIDTH = 90;
            const POI_SIGN_HEIGH
